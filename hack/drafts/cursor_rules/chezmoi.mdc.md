---
description: Best practices and reference for working with Chezmoi dotfile manager
globs: *.go, *.toml, *.tmpl
alwaysApply: false
---
# Chezmoi Dotfile Manager

Guidelines for working with the Chezmoi dotfile management tool and its codebase.


<rule>
name: chezmoi_dotfile_manager
description: Guidelines for working with Chezmoi dotfile management tool
filters:
  # Match Go files
  - type: file_extension
    pattern: "\\.go$"
  # Match template files
  - type: file_extension
    pattern: "\\.tmpl$"
  # Match TOML configuration files
  - type: file_extension
    pattern: "\\.toml$"
  # Match chezmoi-related content
  - type: content
    pattern: "(?i)(chezmoi|dotfiles|source state|target state)"

actions:
  - type: suggest
    message: |
      # Chezmoi Dotfile Manager

      Chezmoi is a powerful dotfile management tool written in Go that helps users manage their configuration files across multiple machines securely.

      ## Core Concepts

      1. **Source State**: The desired state of your dotfiles, stored in `~/.local/share/chezmoi` by default.
      2. **Destination Directory**: The directory that chezmoi manages, usually your home directory (`~`).
      3. **Target State**: The computed desired state for the destination directory, based on the source state, configuration, and templates.
      4. **Config File**: Contains machine-specific data, stored in `~/.config/chezmoi/chezmoi.toml` by default.

      ## Repository Structure

      ```
      .
      ├── home/                    # Source state directory
      │   ├── dot_config/          # Configuration files (.config)
      │   ├── dot_local/           # Local files (.local)
      │   ├── private_dot_ssh/     # SSH configuration (private)
      │   ├── executable_scripts/  # Executable scripts
      │   └── run_once_setup.sh    # One-time setup script
      ├── .chezmoi.toml.tmpl      # Template for chezmoi configuration
      └── .chezmoiexternal.toml   # External file definitions
      ```

      ## Template Patterns and Best Practices

      ### 1. OS-Specific Configuration

      Use `.chezmoi.os` for OS-specific configurations:

      ```go
      {{- if eq .chezmoi.os "darwin" }}
      # macOS Configuration
      export HOMEBREW_PREFIX="/opt/homebrew"
      export PATH="$HOMEBREW_PREFIX/bin:$PATH"
      {{- else if eq .chezmoi.os "linux" }}
      # Linux Configuration
      export PATH="/usr/local/bin:$PATH"
      {{- end }}
      ```

      ### 2. Shell-Specific Templates

      Detect and configure based on shell type:

      ```go
      {{- if eq .chezmoi.shell "zsh" }}
      # ZSH specific settings
      source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
      {{- else if eq .chezmoi.shell "bash" }}
      # Bash specific settings
      source ~/.bashrc.d/aliases.bash
      {{- end }}
      ```

      ### 3. Machine-Specific Configuration

      Use hostname or custom variables for machine-specific settings:

      ```go
      {{- if eq .chezmoi.hostname "work-laptop" }}
      # Work environment settings
      export http_proxy="http://proxy.company.com:8080"
      {{- else }}
      # Personal environment settings
      unset http_proxy
      {{- end }}
      ```

      ### 4. External Dependencies

      Define external dependencies in `.chezmoiexternal.toml`:

      ```toml
      [".oh-my-zsh"]
        type = "archive"
        url = "https://github.com/ohmyzsh/ohmyzsh/archive/master.tar.gz"
        exact = true
        stripComponents = 1
        refreshPeriod = "168h"

      [".vim/pack/plugins/start/vim-go"]
        type = "git-repo"
        url = "https://github.com/fatih/vim-go.git"
        refreshPeriod = "168h"
      ```

      ### 5. Environment Variables and Secrets

      Handle sensitive data using environment variables or password managers:

      ```go
      {{- if env "WORK_MACHINE" }}
      # Work-specific configuration with secrets
      export API_KEY="{{ (onepassword "Work API Key").password }}"
      {{- else }}
      # Personal configuration
      export API_KEY="{{ (pass "personal/api-key") }}"
      {{- end }}
      ```

      ### 6. Directory Structure Templates

      Create consistent directory structures:

      ```go
      {{- $config := .chezmoi.homeDir }}/.config
      {{- $data := .chezmoi.homeDir }}/.local/share

      {{- $dirs := list
        (joinPath $config "nvim")
        (joinPath $config "tmux")
        (joinPath $data "zsh")
      -}}

      {{- range $dirs }}
      {{ . }} = "directory"
      {{- end }}
      ```

      ### 7. Conditional File Management

      Handle files based on conditions:

      ```go
      {{- if stat (joinPath .chezmoi.homeDir ".ssh/id_rsa") }}
      # SSH key exists, configure SSH agent
      eval "$(ssh-agent -s)"
      ssh-add ~/.ssh/id_rsa
      {{- end }}
      ```

      ### 8. Script Templates

      Create dynamic script templates:

      ```bash
      #!/bin/bash

      # Generated by chezmoi - DO NOT EDIT DIRECTLY

      {{- if eq .chezmoi.os "darwin" }}
      # Install macOS packages
      brew bundle --file=~/.Brewfile
      {{- else if eq .chezmoi.os "linux" }}
      # Install Linux packages
      {{- if lookPath "apt-get" }}
      sudo apt-get update && sudo apt-get install -y $(cat ~/.packages)
      {{- else if lookPath "yum" }}
      sudo yum install -y $(cat ~/.packages)
      {{- end }}
      {{- end }}
      ```

      ## Common Operations

      ### 1. Adding New Files

      ```bash
      # Add a file as a template
      chezmoi add --template ~/.bashrc

      # Add a private file
      chezmoi add --encrypt ~/.ssh/id_rsa

      # Add a directory
      chezmoi add ~/.config/nvim
      ```

      ### 2. Applying Changes

      ```bash
      # Apply all changes
      chezmoi apply

      # Apply specific files
      chezmoi apply ~/.bashrc

      # Apply with debug information
      chezmoi apply -v
      ```

      ### 3. Managing Source Files

      ```bash
      # Edit a managed file
      chezmoi edit ~/.bashrc

      # View changes before applying
      chezmoi diff

      # Update from source repository
      chezmoi update
      ```

examples:
  - input: |
      # Adding a new dotfile to chezmoi
      I want to add my .bashrc file to chezmoi
    output: |
      To add your .bashrc file to chezmoi, use the `add` command:

      ```bash
      chezmoi add ~/.bashrc
      ```

      This will copy the file to your source directory (typically `~/.local/share/chezmoi`) with the appropriate prefix (`dot_bashrc`).

      If you want to edit it immediately after adding:

      ```bash
      chezmoi add --template ~/.bashrc
      chezmoi edit ~/.bashrc
      ```

      The `--template` flag will convert the file to a template, allowing you to use template directives for machine-specific configurations.

  - input: |
      # Creating a template with OS-specific configuration
      I need different configurations for Linux and macOS
    output: |
      You can use Go's template system to create OS-specific configurations:

      ```bash
      chezmoi edit ~/.bashrc
      ```

      Then add conditional logic based on the operating system:

      ```bash
      # Common configuration

      {{- if eq .chezmoi.os "darwin" }}
      # macOS specific configuration
      export PATH="/opt/homebrew/bin:$PATH"
      alias ls="ls -G"
      {{- else if eq .chezmoi.os "linux" }}
      # Linux specific configuration
      export PATH="/usr/bin:$PATH"
      alias ls="ls --color=auto"
      {{- end }}

      # More common configuration
      ```

      This template will generate different content based on whether you're on macOS or Linux when you run `chezmoi apply`.

  - input: |
      # Managing secrets with chezmoi
      How do I store my API keys securely?
    output: |
      Chezmoi offers several ways to manage secrets:

      1. Using a password manager (recommended):

      ```bash
      # Store your API key in your password manager first, then:
      chezmoi edit ~/.config/service/config.yaml
      ```

      In the file, use template directives to retrieve the secret:

      ```yaml
      api_key: {{ (bitwarden "item" "My API Key").notes }}
      # Or with 1Password:
      api_key: {{ (onepassword "item" "My API Key").password }}
      ```

      2. Using age encryption:

      ```bash
      # First, set up age encryption:
      chezmoi init --apply
      chezmoi age setup

      # Then add your file with encryption:
      chezmoi add --encrypt ~/.config/service/config.yaml
      ```

      This will encrypt the file in your source state, and decrypt it when applying.

metadata:
  priority: high
  version: 1.0
  tags:
    - dotfiles
    - configuration-management
    - go
    - templates
    - secrets
</rule>
